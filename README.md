Формат конфигурационного yaml файла:
===============================

:conf:       
------

token: '655499892:AAH28sihyt6RxlnmT6w-ooF4aL_oRD_mT-0'
токен бота

Опционально:
------------
  proxy: http://....
  proxy_user: ....
  proxy_pass: ....
  proxy_http: yes/no
  Если 'no' - socks5-прокси

  service_port: 8002

:states: (таблица состояний)
--------

**Внимание**: ключи :unauthorized, :state, :menu и :events начинаются с ':', все остальные (пока) - нет.

    имя_состояния:
      msg: Выбери вариант!     # сообщение при переходе в состояние

      :unauthorized: state     # немедленно перейти в состояние state, если пользователь
                               # не авторизован (всё остальное, кроме переменных, игнорируется)
      :state:  state           # после выполнения остальных действий перейти в состояние state
                               # не стоит совмещать с :menu:, там работать не будет

      :menu:                   # вывести меню при переходе в состояние
        e1: "Привет !"         # имя события / пункт меню
        ...

      :events:                 # список событий
        имя_события:           # можно использовать _other = любой другой вариант 
                               # (имя события записывается в переменной last_event)
                               #
          msg: Привет!         # сообщение при получении события
          state: e2            # имя нового состояния
  
          exec: cmd arg        # выполнить команду (программу)
          ok_state: e2         # если код возврата 0 - перейти в новое состояние
          fail_state: e3       # если код возврата не 0 - перейти в новое состояние


Особые параметры в состояниях
-----------------

### Аутентификация

auth_check: "приглашение"      # Требуется ввести ответ на секретный вопрос. Предварительно выводится приглашение
auth_answer: "..."             # Ответ на секретный вопрос
auth_cmd: "..."                # Команда проверки. Ей передаётся ответ и имя пользователя.
                               # Если она выдаёт на стандартный вывод 'ok', проверка пройдена
auth_fail: "..."               # Сообщение при провале проверки
fail_state: state              # Состояние при провале проверки
auth_msg: "..."                # Сообщение при успешной проверке
ok_state: state                # Состояние при успешной проверке
timeout: N                     # Таймаут выполнения программы порверки

**TODO**: сделать auth_check_cmd и выводить приглашение из вызова команды.
**TODO**: передавать командам переменные окружения с данными о пользователе.

### Подписки

subscriptions: type            # действия с подписками. Возможные варианты:
                               # all  = перечислить список всех доступных
                               # my   = перечислить те, на которые подписан пользователь
                               # new  = подписать на новую
                               # del  = отписать от какой-то
next_state: st                 # после 'all' или 'my' перейти в указанное состояние
cancel: "..."                  # текст пункта отказа подписки/отписки (по умолчанию "Отказ")
ok_state: st                   # перейти в указанное состояние после подписки/отписки
ok_msg: "..."                  # выдать сообщение после подписки/отписки
cancel_state: st               # перейти в указанное состояние при отказе от подписки/отписки
cancel_msg: "..."              # выдать сообщение при отказе от подписки/отписки


### Выполнение программы

exec: cmd                      # выполнить программу
ok_state: st                   # перейти в состояние если команда вернула код 0
fail_state: st                 # перейти в состояние если команда вернула код не 0
next_state: st                 # перейти в состояние при любом коде возврата
is_jpeg: anything              # результат - путь к картинке в формате jpg
is_png: anything               # результат - путь к картинке в формате png
is_gif: anything               # результат - путь к картинке в формате gif
is_menu: anything              # результат - описание меню (пункты через ';', формат элемента - 'строка=состояние')
lines:  @N,@M                  # @ = '+'/'' или '-', N,M - целые. Значение - вырезать часть строк вывода программы.
                               # Берётся M строк с N-той, если M<0, то до M-той с конца.
                               # Счёт идет с 0 !!!
timeout: N                     # Таймаут выполнения программы


Обработчики
===========

````
class BlaBlaBlaProcessor < GenericProcessor
  class << self

    # Вызывается при переходе в новое состояние событием event
    # Если возвращается true, то затем немедленно вызывается on_enter 
    def can_enter processor, event
      false
    end

    # Вызывается получении события event
    # Если возвращается true, то затем немедленно вызывается on_event
    def can_process_event processor, event
      false
    end

    # Вызывается при переходе из состояния old в новое состояние событием event
    def on_enter processor, old, event
      processor.sender.send_message processor.get_var('hello', 'Привет, '+processor.username)
    end

    # Вызывается при получениии события event
    def on_event processor, event
      processor.sender.send_message "Привет, я "+processor.get_var('my_name', 'Бот Вася')
      processor.change_state processor.get_var('new_state','main')
    end
  end #self
end

StateProcessor.register_processor BlaBlaBlaProcessor
````


Класс Processor
===============

log x
-----
Вывод строки в лог

change_state new_state
----------------------
Перейти в новое состояние

set_var name, value
-------------------
Установить переменную

get_var name, default=nil
-------------------------
Получить переменную

set_auth [1/0]
---------------
Урстановить/сбросить авторизацию пользователя

state
------
Получить текущее состояние

opts
----
Получить параметры, перенданные в конструктор

sender
------
Объект класса Sender

conf
----
Настройки

Автоматические переменные
-------------------------
username = имя пользоателя
authorized = 1, если авторизован, 0, если нет
groups = все группы
user_groups = группы пользователя


Класс Sender
============

initialize bot, user
--------------------
Конструктор

send_message msg, opts=nil, chat=nil
------------------------------------
Послать сообщение msg

send_photo chat, photo
----------------------
Послать картинку
